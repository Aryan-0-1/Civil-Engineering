{#{% load static %}#}
{#<!DOCTYPE html>#}
{#<html lang="en">#}
{#<head>#}
{#  <meta charset="utf-8" />#}
{#  <title>Water Quality Parameter of Ganga — Varanasi</title>#}
{#  <meta name="viewport" content="width=device-width, initial-scale=1" />#}
{#  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">#}
{##}
{#  <!-- Chart.js -->#}
{#  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>#}
{#  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>#}
{##}
{#  <style>#}
{#    body { margin:0; font-family:Arial; background:#f4f4f9; }#}
{#    header { padding:20px; background:maroon; color:white; text-align:center; }#}
{#    .container { margin:30px auto; max-width:900px; background:white; padding:25px; border-radius:8px; border:2px solid maroon; }#}
{#    .row { display:flex; gap:15px; margin-top:15px; flex-wrap:wrap; }#}
{#    label { font-weight:bold; color:maroon; }#}
{#    input[type="date"], select { padding:8px; border-radius:5px; border:2px solid #ccc; }#}
{#    button { padding:10px 20px; background:maroon; border:none; color:white; border-radius:6px; cursor:pointer; }#}
{#    #tableContainer { margin-top:25px; }#}
{#    #chartWrap { margin-top:30px; display:none; }#}
{#    .chart-block { margin-bottom:30px; }#}
{#    .canvas-wrapper{ width:100%; height:350px; }#}
{#  </style>#}
{#</head>#}
{##}
{#<body>#}
{##}
{#<header>#}
{#  <h1>Water Quality Prediction</h1>#}
{#</header>#}
{##}
{#<div class="container">#}
{#  <h2 style="color:maroon">Water Quality Parameter of Ganga — Varanasi</h2>#}
{##}
{#  <!-- Form -->#}
{#  <form id="predictForm">#}
{#    {% csrf_token %}#}
{#    <div class="row">#}
{##}
{#      <label>Location</label>#}
{#      <select id="location" name="location" required>#}
{#        <option value="assi_ghat">Assi Ghat</option>#}
{#      </select>#}
{##}
{#      <label>Start Date</label>#}
{#      <input type="date" id="startDate" name="start_date" required>#}
{##}
{#      <label>End Date</label>#}
{#      <input type="date" id="endDate" name="end_date" required>#}
{##}
{#      <button type="submit" id="submitBtn">Submit</button>#}
{##}
{#    </div>#}
{#  </form>#}
{##}
{#  <!-- DataFrame Output -->#}
{#  <div id="tableContainer"></div>#}
{##}
{#  <!-- Charts -->#}
{#  <div id="chartWrap">#}
{##}
{#    <div class="chart-block">#}
{#      <h3 style="color:maroon">Predicted pH</h3>#}
{#      <div class="canvas-wrapper">#}
{#        <canvas id="phChart"></canvas>#}
{#      </div>#}
{#    </div>#}
{##}
{#    <div class="chart-block">#}
{#      <h3 style="color:maroon">Predicted DO (mg/L)</h3>#}
{#      <div class="canvas-wrapper">#}
{#        <canvas id="doChart"></canvas>#}
{#      </div>#}
{#    </div>#}
{##}
{#  </div>#}
{##}
{#  <!-- DOWNLOAD BUTTONS -->#}
{#  <div style="margin-top:25px; text-align:center;">#}
{#    <button id="downloadCSV" style="margin-right:15px;">Download CSV</button>#}
{#    <button id="downloadCharts">Download Charts</button>#}
{#  </div>#}
{##}
{#</div> <!-- container end -->#}
{##}
{#<script>#}
{#  const phCtx = document.getElementById('phChart').getContext('2d');#}
{#  const doCtx = document.getElementById('doChart').getContext('2d');#}
{##}
{#  let phChart = new Chart(phCtx, {#}
{#    type: 'line',#}
{#    data: { datasets:[{ label:"pH", data:[], borderColor:"maroon", borderWidth:2 }] },#}
{#    options:{ responsive:true, scales:{ x:{type:"time"}, y:{beginAtZero:false} } }#}
{#  });#}
{##}
{#  let doChart = new Chart(doCtx, {#}
{#    type: 'line',#}
{#    data: { datasets:[{ label:"DO", data:[], borderColor:"orange", borderWidth:2 }] },#}
{#    options:{ responsive:true, scales:{ x:{type:"time"}, y:{beginAtZero:false} } }#}
{#  });#}
{##}
{#  document.getElementById('predictForm').addEventListener('submit', async function(e){#}
{#    e.preventDefault();#}
{##}
{#    const formData = new FormData(this);#}
{##}
{#    const response = await fetch("{% url 'water_predict' %}", {#}
{#      method: "POST",#}
{#      body: formData#}
{#    });#}
{##}
{#    const data = await response.json();#}
{##}
{#    // insert dataframe html#}
{#    document.getElementById("tableContainer").innerHTML = data.table_html;#}
{##}
{#    // update pH chart#}
{#    phChart.data.datasets[0].data = data.dates.map((d,i)=>({x:d,y:data.ph[i]}));#}
{#    phChart.update();#}
{##}
{#    // update DO chart#}
{#    doChart.data.datasets[0].data = data.dates.map((d,i)=>({x:d,y:data.do[i]}));#}
{#    doChart.update();#}
{##}
{#    document.getElementById("chartWrap").style.display = "block";#}
{#  });#}
{##}
{##}
{#  /* ---------------------- CSV DOWNLOAD (HTML-ONLY) ---------------------- */#}
{#  document.getElementById("downloadCSV").addEventListener("click", function () {#}
{#      const table = document.querySelector("#tableContainer table");#}
{##}
{#      if (!table) {#}
{#          alert("No data available to download.");#}
{#          return;#}
{#      }#}
{##}
{#      let csv = [];#}
{#      const rows = table.querySelectorAll("tr");#}
{##}
{#      rows.forEach(row => {#}
{#          let cols = row.querySelectorAll("th, td");#}
{#          let rowData = [];#}
{#          cols.forEach(col => {#}
{#              rowData.push(col.innerText.replace(/,/g, ""));#}
{#          });#}
{#          csv.push(rowData.join(","));#}
{#      });#}
{##}
{#      const blob = new Blob([csv.join("\n")], { type: "text/csv" });#}
{#      const url = URL.createObjectURL(blob);#}
{#      const a = document.createElement("a");#}
{##}
{#      a.href = url;#}
{#      a.download = "water_quality.csv";#}
{#      a.click();#}
{##}
{#      URL.revokeObjectURL(url);#}
{#  });#}
{##}
{##}
{#  /* ---------------------- COMBINED PNG DOWNLOAD ---------------------- */#}
{#  document.getElementById("downloadCharts").addEventListener("click", function () {#}
{#      const phImg = phChart.toBase64Image();#}
{#      const doImg = doChart.toBase64Image();#}
{##}
{#      const canvas = document.createElement("canvas");#}
{#      const ctx = canvas.getContext("2d");#}
{##}
{#      const width = 1200;#}
{#      const height = 800;#}
{##}
{#      canvas.width = width;#}
{#      canvas.height = height;#}
{##}
{#      const img1 = new Image();#}
{#      img1.src = phImg;#}
{##}
{#      img1.onload = () => {#}
{#          ctx.drawImage(img1, 0, 0, width, height / 2);#}
{##}
{#          const img2 = new Image();#}
{#          img2.src = doImg;#}
{##}
{#          img2.onload = () => {#}
{#              ctx.drawImage(img2, 0, height / 2, width, height / 2);#}
{##}
{#              const link = document.createElement("a");#}
{#              link.href = canvas.toDataURL("image/png");#}
{#              link.download = "water_quality_charts.png";#}
{#              link.click();#}
{#          };#}
{#      };#}
{#  });#}
{#</script>#}
{##}
{#</body>#}
{#</html>#}







{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Water Quality Parameter of Ganga — Varanasi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    body { margin:0; font-family:Arial; background:#f4f4f9; }
    header { padding:20px; background:maroon; color:white; text-align:center; }
    .container { margin:30px auto; max-width:900px; background:white; padding:25px; border-radius:8px; border:2px solid maroon; }
    .row { display:flex; gap:15px; margin-top:15px; flex-wrap:wrap; }
    label { font-weight:bold; color:maroon; }
    input[type="date"], select { padding:8px; border-radius:5px; border:2px solid #ccc; }
    button { padding:10px 20px; background:maroon; border:none; color:white; border-radius:6px; cursor:pointer; }
    #tableContainer { margin-top:25px; }
    #chartWrap { margin-top:30px; display:none; }
    .chart-block { margin-bottom:30px; }
    .canvas-wrapper{ width:100%; height:350px; }

    .home-btn-container {
        position: absolute;
        top: 20px;
        right: 30px;
        border: 1px solid #000;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
    }

    .home-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: maroon;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .home-btn:hover {
            background-color: #800000;
        }


  </style>
</head>

<body>

<header>
  <h1>Water Quality Prediction</h1>
    <div class="home-btn-container">
        <a href="/" class="home-btn">Home</a>
    </div>
</header>

<div class="container">
  <h2 style="color:maroon">Water Quality Parameter of Ganga — Varanasi</h2>

  <!-- Form -->
  <form id="predictForm">
    {% csrf_token %}
    <div class="row">

      <label>Location</label>
      <select id="location" name="location" required>
        <option value="assi_ghat">Assi Ghat</option>
      </select>

      <label>Start Date</label>
      <input type="date" id="startDate" name="start_date" required>

      <label>End Date</label>
      <input type="date" id="endDate" name="end_date" required>

      <button type="submit" id="submitBtn">Submit</button>

    </div>
  </form>

  <!-- DataFrame Output -->
  <div id="tableContainer"></div>

  <!-- Charts -->
  <div id="chartWrap">

    <div class="chart-block">
      <h3 style="color:maroon">Predicted pH</h3>
      <div class="canvas-wrapper">
        <canvas id="phChart"></canvas>
      </div>
    </div>

    <div class="chart-block">
      <h3 style="color:maroon">Predicted DO (mg/L)</h3>
      <div class="canvas-wrapper">
        <canvas id="doChart"></canvas>
      </div>
    </div>

  </div>

  <!-- DOWNLOAD + RESET BUTTONS -->
  <div style="margin-top:25px; text-align:center;">
    <button id="downloadCSV" style="margin-right:15px;">Download CSV</button>
    <button id="downloadCharts">Download Charts</button>
    <br><br>
    <button id="resetPage" style="background:#555;">Reset</button>
  </div>

</div> <!-- container end -->

<script>
  const phCtx = document.getElementById('phChart').getContext('2d');
  const doCtx = document.getElementById('doChart').getContext('2d');

  let phChart = new Chart(phCtx, {
    type: 'line',
    data: { datasets:[{ label:"pH", data:[], borderColor:"maroon", borderWidth:2 }] },
    options:{ responsive:true, scales:{ x:{type:"time"}, y:{beginAtZero:false} } }
  });

  let doChart = new Chart(doCtx, {
    type: 'line',
    data: { datasets:[{ label:"DO", data:[], borderColor:"orange", borderWidth:2 }] },
    options:{ responsive:true, scales:{ x:{type:"time"}, y:{beginAtZero:false} } }
  });

  document.getElementById('predictForm').addEventListener('submit', async function(e){
    e.preventDefault();

    const formData = new FormData(this);

    const response = await fetch("{% url 'water_predict' %}", {
      method: "POST",
      body: formData
    });

    const data = await response.json();

    // insert dataframe html
    document.getElementById("tableContainer").innerHTML = data.table_html;

    // update pH chart
    phChart.data.datasets[0].data = data.dates.map((d,i)=>({x:d,y:data.ph[i]}));
    phChart.update();

    // update DO chart
    doChart.data.datasets[0].data = data.dates.map((d,i)=>({x:d,y:data.do[i]}));
    doChart.update();

    document.getElementById("chartWrap").style.display = "block";
  });


  /* ---------------------- CSV DOWNLOAD ---------------------- */
  document.getElementById("downloadCSV").addEventListener("click", function () {
      const table = document.querySelector("#tableContainer table");

      if (!table) {
          alert("No data available to download.");
          return;
      }

      let csv = [];
      const rows = table.querySelectorAll("tr");

      rows.forEach(row => {
          let cols = row.querySelectorAll("th, td");
          let rowData = [];
          cols.forEach(col => {
              rowData.push(col.innerText.replace(/,/g, ""));
          });
          csv.push(rowData.join(","));
      });

      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");

      a.href = url;
      a.download = "water_quality.csv";
      a.click();

      URL.revokeObjectURL(url);
  });


  /* ---------------------- COMBINED PNG DOWNLOAD ---------------------- */
  document.getElementById("downloadCharts").addEventListener("click", function () {
      const phImg = phChart.toBase64Image();
      const doImg = doChart.toBase64Image();

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const width = 1200;
      const height = 800;

      canvas.width = width;
      canvas.height = height;

      const img1 = new Image();
      img1.src = phImg;

      img1.onload = () => {
          ctx.drawImage(img1, 0, 0, width, height / 2);

          const img2 = new Image();
          img2.src = doImg;

          img2.onload = () => {
              ctx.drawImage(img2, 0, height / 2, width, height / 2);

              const link = document.createElement("a");
              link.href = canvas.toDataURL("image/png");
              link.download = "water_quality_charts.png";
              link.click();
          };
      };
  });


  /* ---------------------- RESET BUTTON ---------------------- */
  document.getElementById("resetPage").addEventListener("click", function () {

      // Clear date fields
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";

      // Clear table
      document.getElementById("tableContainer").innerHTML = "";

      // Hide charts
      document.getElementById("chartWrap").style.display = "none";

      // Clear chart data
      phChart.data.datasets[0].data = [];
      doChart.data.datasets[0].data = [];
      phChart.update();
      doChart.update();
  });
</script>

</body>
</html>
